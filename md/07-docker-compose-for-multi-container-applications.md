# Урок 7. Docker Compose для многоконтейнерных приложений

## Введение в Docker Compose

**Docker Compose** — это мощный инструмент, упрощающий управление многоконтейнерными приложениями Docker. Он позволяет определять и запускать несколько контейнеров как одну службу с помощью простого файла конфигурации YAML. С Docker Compose вы можете легко организовать развертывание приложений, состоящих из нескольких служб, таких как веб-серверы, базы данных и системы кэширования.

### Преимущества использования Docker Compose

1. **Упрощенная конфигурация**: Docker Compose использует один файл `docker-compose.yml` для определения всех служб, сетей и томов, необходимых для вашего приложения. Это упрощает управление сложными настройками.

2. **Управление несколькими контейнерами**: вы можете запускать, останавливать и управлять несколькими контейнерами с помощью одной команды, что упрощает ваш рабочий процесс.

3. **Согласованность среды**: Docker Compose гарантирует, что ваше приложение будет работать в одной и той же среде в разных системах, что упрощает разработку, тестирование и развертывание.

4. **Зависимости служб**: Compose позволяет вам определять зависимости между службами, гарантируя, что они запускаются в правильном порядке.

5. **Масштабирование служб**: вы можете легко масштабировать службы вверх или вниз, указав количество экземпляров контейнеров в файле `docker-compose.yml`.

## Создание файла `docker-compose.yml`

Чтобы проиллюстрировать, как использовать Docker Compose, мы создадим простое многоконтейнерное приложение, состоящее из веб-сервера (использующего Flask) и базы данных Redis.

### Шаг 1. Создайте каталог проекта

1. Откройте терминал и создайте новый каталог для вашего проекта:

```bash
mkdir my-flask-app
cd my-flask-app
```

### Шаг 2. Создайте приложение Flask

2. Создайте файл с именем `app.py` со следующим содержимым:

```python
from flask import Flask
import redis

app = Flask(__name__)
redis_client = redis.StrictRedis(host='redis', port=6379, decode_responses=True)

@app.route('/')
def index():
visits = redis_client.incr('counter')
return f'Hello, World! You are visitor number {visits}.'

if __name__ == '__main__':
app.run(host='0.0.0.0')
```

### Шаг 3. Создайте `requirements.txt`

3. Создайте файл с именем `requirements.txt` со следующим содержимым:

```
Flask
redis
```

### Шаг 4. Создайте файл `docker-compose.yml`

4. В том же каталоге создайте файл с именем `docker-compose.yml` и добавьте следующее содержимое:

```yaml
version: '3.8'

services:
web:
build: .
ports:
- "5000:5000"
dependent_on:
- redis

redis:
image: "redis:alpine"
```

### Объяснение файла `docker-compose.yml`

- **version**: указывает версию формата файла Docker Compose.
- **services**: определяет различные службы, из которых состоит ваше приложение.
- **web**: служба веб-приложения Flask.
- **build**: указывает, что Docker должен построить образ из Dockerfile в текущем каталоге.
- **ports**: сопоставляет порт 5000 на хосте с портом 5000 в контейнере.
- **depends_on**: указывает, что служба `web` зависит от службы `redis`, гарантируя, что Redis запустится до веб-приложения.
- **redis**: служба Redis, использующая официальный образ Redis из Docker Hub.

### Шаг 5: Создайте Dockerfile

5. Создайте файл с именем `Dockerfile` в том же каталоге со следующим содержимым:

```dockerfile
# Используйте официальный образ Python из Docker Hub
FROM python:3.9-slim

# Установите рабочий каталог в контейнере
WORKDIR /app

# Скопируйте файл требований и установите зависимости
COPY requirements.txt requirements.txt
RUN pip install --no-cache-dir -r requirements.txt

# Скопируйте код приложения в контейнер
COPY app.py app.py

# Команда для запуска приложения
CMD ["python", "app.py"]
```

## Запуск настройки нескольких контейнеров

### Шаг 1: Сборка и запуск служб

1. В терминале выполните следующую команду для сборки образов и запуска служб, определенных в файле `docker-compose.yml`:

```bash
docker compose up
```

Эта команда создаст образ веб-службы и запустит как веб-службу, так и службу Redis. Вы должны увидеть журналы, указывающие на то, что службы запущены.

### Шаг 2: Доступ к приложению

2. Откройте веб-браузер и перейдите по адресу `http://localhost:5000`. Вы должны увидеть сообщение с указанием количества посетителей:

```
Hello, World! Вы посетитель номер 1.
```

Обновите страницу, чтобы увидеть увеличение количества посетителей.

### Шаг 3: Остановка служб

3. Чтобы остановить службы, вы можете нажать `Ctrl + C` в терминале, где запущен Docker Compose. Или вы можете запустить:

```bash
docker compose down
```

Эта команда останавливает и удаляет контейнеры, определенные в файле `docker-compose.yml`.

## Заключение

В этом уроке вы узнали о Docker Compose и его преимуществах для управления многоконтейнерными приложениями. Вы создали файл `docker-compose.yml` для определения простого приложения Flask и базы данных Redis, а также запустили многоконтейнерную настройку с помощью одной команды. В следующем уроке мы рассмотрим расширенные функции Docker Compose, включая переменные среды и службы масштабирования.


### Контрольные вопросы:
1. Что такое `Docker Compose` и для чего он используется?
2. Какие основные преимущества использования `Docker Compose` для управления многоконтейнерными приложениями?
3. Какие основные разделы и директивы используются в файле `docker-compose.yml`?
4. Как запустить многоконтейнерное приложение с помощью `Docker Compose`?
5. Как остановить и удалить контейнеры, запущенные с помощью `Docker Compose`?
